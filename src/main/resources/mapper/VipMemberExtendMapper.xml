<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="weixin.assistant.dao.VipMemberExtendMapper">

    <update id="incMoneyInputByExample" parameterType="map">
        <!--
          WARNING - @mbggenerated
          This element is automatically generated by MyBatis Generator, do not modify.
        -->
        update vip_member
        set
        money_input = money_input+ #{fee,jdbcType=INTEGER}
        where id = #{id,jdbcType=INTEGER}
    </update>
    <update id="incMoneyOutputByExample" parameterType="map">
        <!--
          WARNING - @mbggenerated
          This element is automatically generated by MyBatis Generator, do not modify.
        -->
        update vip_member
        set
        money_output = money_output+ #{fee,jdbcType=INTEGER}
        where id = #{id,jdbcType=INTEGER}
    </update>

    <select id="czSearchForList" parameterType="map" resultType="java.util.Map">

        select m.id as vipCardNumMapKey,m.name as vipNameMapKey,m.tel as phoneMapKey,
        m.create_time as createTimeMapKey,m.status as statusMapKey,
        (m.money_input-m.money_output) as feeMapKey,b.name as mendianMapKey,
        r.finish_time as czTimeMapKey,r.fee as czMoneyMapKey
        from vip_business b,vip_member m,vip_recharge_order r
        where
        m.id=r.member_id and r.business_id=b.id
        and r.status=#{status}
        <if test="accountID != null">
            and b.account_id=#{accountID}
        </if>
        <if test="vipName != null">
            and m.name like "%"#{vipName}"%"
        </if>
        <if test="businessName != null">
            and b.name=#{businessName}
        </if>
        <if test="czFinishTime != null">
            and r.finish_time like "%"#{czFinishTime}"%"
        </if>
        <if test="tel != null">
            and m.tel=#{tel}
        </if>
        <if test="czMoneyMin != null">
            and r.fee BETWEEN #{czMoneyMin} AND #{czMoneyMax}
        </if>
        ORDER BY r.finish_time DESC limit #{start},#{pageSize}
    </select>
    <select id="czSearchTotalCount" parameterType="map" resultType="int">

        select count(*) from vip_business b,vip_member m,vip_recharge_order r
        where
        m.id=r.member_id and r.business_id=b.id
        and r.status=#{status}
        <if test="accountID != null">
            and b.account_id=#{accountID}
        </if>
        <if test="vipName != null">
            and m.name like "%"#{vipName}"%"
        </if>
        <if test="businessName != null">
            and b.name=#{businessName}
        </if>
        <if test="czFinishTime != null">
            and r.finish_time like "%"#{czFinishTime}"%"
        </if>
        <if test="tel != null">
            and m.tel=#{tel}
        </if>
        <if test="czMoneyMin != null">
            and r.fee BETWEEN #{czMoneyMin} AND #{czMoneyMax}
        </if>
    </select>

    <select id="xfSearchForList" parameterType="map" resultType="java.util.Map">

         select m.id as vipCardNumMapKey,m.name as vipNameMapKey,
        m.tel as phoneMapKey,m.create_time as createTimeMapKey,
        m.status as statusMapKey,(m.money_input-m.money_output) as feeMapKey,b.name as mendianMapKey,
         p.coupons_type,p.finish_time as xfTimeMapKey,p.fee as xfMoneyMapKey,p.pay_type
         from vip_business b,vip_member m,vip_pay_order p
         where
         p.business_id=b.id and p.member_id=m.id
         and p.status=#{status}
        <if test="accountID != null">
            and b.account_id=#{accountID}
        </if>
        <if test="vipName != null">
             and m.name like "%"#{vipName}"%"
         </if>
         <if test="businessName != null">
             and b.name=#{businessName}
         </if>
         <if test="xfFinishTime != null">
             and p.finish_time like "%"#{xfFinishTime}"%"
         </if>
         <if test="tel != null">
             and m.tel=#{tel}
         </if>
         <if test="payType != null">
             and p.pay_type=#{payType}
         </if>
        <if test="xfMoneyMin != null">
            and p.fee BETWEEN #{xfMoneyMin} AND #{xfMoneyMax}
        </if>
        ORDER BY p.finish_time DESC limit #{start},#{pageSize}
     </select>
    <select id="xfSearchTotalCount" parameterType="map" resultType="int">
        select count(*) from vip_business b,vip_member m,vip_pay_order p
        where
        p.business_id=b.id and p.member_id=m.id
        and p.status=#{status}
        <if test="accountID != null">
            and b.account_id=#{accountID}
        </if>
        <if test="vipName != null">
            and m.name like "%"#{vipName}"%"
        </if>
        <if test="businessName != null">
            and b.name=#{businessName}
        </if>
        <if test="xfFinishTime != null">
            and p.finish_time like "%"#{xfFinishTime}"%"
        </if>
        <if test="tel != null">
            and m.tel=#{tel}
        </if>
        <if test="payType != null">
            and p.pay_type=#{payType}
        </if>
        <if test="xfMoneyMin != null">
           and p.fee BETWEEN #{xfMoneyMin} AND #{xfMoneyMax}
        </if>

    </select>

    <select id="vipQueryForList" parameterType="map" resultType="java.util.Map">

        select m.id as vipCardNumMapKey,m.name as vipNameMapKey,m.tel as phoneMapKey,
        m.create_time as createTimeMapKey,m.status as statusMapKey,
        (m.money_input-m.money_output) as feeMapKey
        from vip_member m
        where
        1 = 1
        <if test="businessID != null">
            and m.business_id =#{businessID}
        </if>
        <if test="searchType == 1">
            and m.id like "%"#{searchName}"%"
        </if>
        <if test="searchType == 2">
            and m.name like "%"#{searchName}"%"
        </if>
        <if test="searchType == 3">
            and m.tel like "%"#{searchName}"%"
        </if>
         limit #{start},#{pageSize}
    </select>
    <select id="vipTotalCount" parameterType="map" resultType="int">

        select count(*) from vip_member m
        where
        1 = 1
        <if test="businessID != null">
            and m.business_id =#{businessID}
        </if>
        <if test="searchType == 1">
            and m.id like "%"#{searchName}"%"
        </if>
        <if test="searchType == 2">
            and m.name like "%"#{searchName}"%"
        </if>
        <if test="searchType == 3">
            and m.tel like "%"#{searchName}"%"
        </if>
        <if test="createTime != null">
            and m.create_time like "%"#{createTime}"%"
        </if>
    </select>


    <select id="userRechargeStatics" parameterType="map" resultType="java.util.Map">

        SELECT SUM(v.fee) AS sumY,DATE_FORMAT(v.finish_time,"%Y-%m-%d") AS finishTime
        FROM vip_recharge_order v
        where
        1 = 1
        <if test="businessID != null">
            and v.business_id = #{businessID}
        </if>
        <if test="finishTime != null">
            and v.finish_time like "%"#{finishTime}"%" AND v.status=1
        </if>
        GROUP BY TO_DAYS(v.finish_time);
    </select>
    <select id="userPayStatics" parameterType="map" resultType="java.util.Map">

        SELECT SUM(vpo.fee) AS sumY,DATE_FORMAT(vpo.finish_time,"%Y-%m-%d") AS finishTime
        FROM vip_pay_order vpo
        where
        1 = 1
        <if test="businessID != null">
            and vpo.business_id = #{businessID}
        </if>
        <if test="finishTime != null">
            and vpo.finish_time like "%"#{finishTime}"%" AND vpo.status=1
        </if>
        GROUP BY TO_DAYS(vpo.finish_time);
    </select>
    <select id="vipDataStatics" parameterType="map" resultType="java.util.Map">

        SELECT count(vm.id) AS sumY,DATE_FORMAT(vm.create_time,"%Y-%m-%d") AS finishTime
        FROM vip_member vm
        where
        1 = 1
        <if test="businessID != null">
            and vm.business_id = #{businessID}
        </if>
        <if test="finishTime != null">
            and vm.create_time like "%"#{finishTime}"%"
        </if>
        GROUP BY TO_DAYS(vm.create_time);
    </select>

    <select id="businessList" parameterType="map" resultType="java.util.Map">

        SELECT vb.id as businessID,vb.name as businessName,vb.tel as businessTel,vb.addr as businessAssr,
        vb.type as businessType
        FROM vip_business vb
        where
        1=1
        <if test="accountID != null">
            and vb.account_id=#{accountID}
        </if>
        limit #{start},#{pageSize}
    </select>
    <select id="businessTotalCount" parameterType="map" resultType="int">

        SELECT count(*)
        FROM vip_business vb
        where
        1=1
        <if test="accountId != null">
            and vb.account_id=#{accountId}
        </if>
    </select>

    <select id="gzhInfoList" parameterType="map" resultType="java.util.Map">

        SELECT wg.name as gzhName,wg.head_img as headImg,wg.service_type_info as gzhType,
        wg.verify_type_info as verifyType,wg.alias as gzhAlias,wg.qrcode_url as qrcodeUrl,
        wg.func_info as funcInfo,wga.authorization_code as authorizationCode,
        wga.authorizer_access_token as authorizerAccessToken,
        wga.authorizer_refresh_token as authorizerRefreshToken,wga.token_expire_time as tokenExpireTime
        FROM weixin_gzh wg,weixin_gzh_authorizer wga
        where
        wg.id=wga.weixin_gzh_id
        <if test="businessID != null">
            and wg.business_id=#{businessID}
        </if>

    </select>
</mapper>